<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://*.supabase.co; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https: blob:; font-src 'self' data: https://cdn.jsdelivr.net; connect-src 'self' https://*.supabase.co wss://*.supabase.co; frame-ancestors 'none'; base-uri 'self'; form-action 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <title>Admin Portal - Signal Training School LMS</title>
    <link rel="icon" type="image/png" href="images/led.jpg">
    <link rel="shortcut icon" type="image/png" href="images/led.jpg">
    <link rel="apple-touch-icon" href="images/led.jpg">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, #0052a3 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        .results-table th,
        .results-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            white-space: nowrap;
            min-width: 100px;
        }
        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--primary-color);
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        }
        .results-table tr:hover {
            background: #f8f9fa;
        }
        /* Responsive table wrapper */
        .table-wrapper {
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            max-width: 100%;
            position: relative;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
        }
        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }
        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .table-wrapper::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Responsive columns - allow wrapping for long content */
        .results-table td.subject-cell,
        .results-table td.exam-cell {
            white-space: normal;
            word-wrap: break-word;
            max-width: 200px;
        }
        /* Mobile responsive */
        @media (max-width: 768px) {
            .results-table {
                font-size: 12px;
            }
            .results-table th,
            .results-table td {
                padding: 8px 6px;
                min-width: 80px;
            }
            .results-table td.subject-cell,
            .results-table td.exam-cell {
                max-width: 150px;
            }
        }
        .grade-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 14px;
        }
        .grade-A { background: #28a745; color: white; }
        .grade-B { background: #17a2b8; color: white; }
        .grade-C { background: #ffc107; color: #000; }
        .grade-D { background: #fd7e14; color: white; }
        .grade-F { background: #dc3545; color: white; }
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            align-items: end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 14px;
        }
        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }
        .filter-group small {
            margin-top: 6px;
        }
        @media (min-width: 1024px) {
            .filter-row {
                grid-template-columns: 200px 200px 1fr 120px;
            }
        }
        @media (max-width: 1023px) and (min-width: 768px) {
            .filter-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .final-grade-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .final-grade-card h3 {
            margin: 0 0 15px 0;
        }
        .final-grade-value {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="images/led.jpg" alt="Signal Training School Logo" class="nav-logo" onclick="window.location.href='index.html'" style="cursor: pointer;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <h1 style="display: none;">üá¨üá≠ Signal Training School LMS</h1>
            </div>
            <div class="nav-user">
                <span id="adminName"></span>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="dashboard-header">
            <h2>Admin Portal - Result Management</h2>
            <p>Centralized management of all exam results and final grades</p>
        </div>
        
        <!-- Statistics -->
        <div class="admin-stats">
            <div class="stat-card">
                <h3>Total Students</h3>
                <div class="value" id="totalStudents">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Exams</h3>
                <div class="value" id="totalExams">0</div>
            </div>
            <div class="stat-card">
                <h3>Completed Exams</h3>
                <div class="value" id="completedExams">0</div>
            </div>
            <div class="stat-card">
                <h3>Results Released</h3>
                <div class="value" id="resultsReleased">0</div>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="filter-section">
            <h3 style="margin-bottom: 15px;">Filter Results</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="filterClass">Class</label>
                    <select id="filterClass" class="form-control" onchange="loadResults()">
                        <option value="all">All Classes</option>
                        <optgroup label="Signals">
                            <option value="signals-basic">SIGNALS BASIC</option>
                            <option value="signals-b-iii-b-ii">SIGNALS B III ‚Äì B II</option>
                            <option value="signals-b-ii-b-i">SIGNALS B II ‚Äì B I</option>
                        </optgroup>
                        <optgroup label="Advanced Courses">
                            <option value="superintendent">SUPERINTENDENT</option>
                            <option value="pre-qualifying">PRE-QUALIFYING</option>
                        </optgroup>
                        <optgroup label="Regimental">
                            <option value="regimental-basic">REGIMENTAL BASIC</option>
                            <option value="regimental-b-iii-b-ii">REGIMENTAL B III ‚Äì B II</option>
                            <option value="regimental-b-ii-b-i">REGIMENTAL B II ‚Äì B I</option>
                        </optgroup>
                        <optgroup label="Specialized">
                            <option value="rso-rsi">RSO / RSI</option>
                            <option value="electronic-warfare-course">ELECTRONIC WARFARE COURSE</option>
                            <option value="tactical-drone-course">TACTICAL DRONE COURSE</option>
                        </optgroup>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterSubject">Subject</label>
                    <select id="filterSubject" class="form-control" onchange="loadResults()">
                        <option value="all">All Subjects</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterStudent">Search Student</label>
                    <input type="text" id="filterStudent" class="form-control" placeholder="Search by username or full name..." oninput="loadResults()" autocomplete="off">
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">Searches both username and full name</small>
                </div>
                <div class="filter-group">
                    <button onclick="loadResults()" class="btn btn-primary" style="min-width: 120px;">Refresh</button>
                </div>
            </div>
        </div>
        
        <!-- Mid-Semester Results Release Section -->
        <div class="card" style="border-left: 4px solid #ffc107; background: #fffbf0;">
            <h3 style="color: #856404; margin-bottom: 15px;">üìä Mid-Semester Results Release</h3>
            <p style="color: #666; margin-bottom: 20px;">
                Release mid-semester results for <strong>BFT 1</strong>, <strong>Mid CS Exams</strong>, <strong>Mid Course Exercise</strong>, 
                and <strong>all Quizzes/Tests</strong> accumulated during the mid-semester period. 
                These results will be visible to students and will be included in the final semester calculations.
            </p>
            <div class="filter-section" style="background: #fff; border: 1px solid #ffc107; border-radius: 5px; padding: 15px;">
                <div class="filter-row">
                    <div class="filter-group" style="flex: 1;">
                        <label for="midSemesterClass">Select Class</label>
                        <select id="midSemesterClass" class="form-control">
                            <option value="all">All Classes</option>
                            <optgroup label="Signals">
                                <option value="signals-basic">SIGNALS BASIC</option>
                                <option value="signals-b-iii-b-ii">SIGNALS B III ‚Äì B II</option>
                                <option value="signals-b-ii-b-i">SIGNALS B II ‚Äì B I</option>
                            </optgroup>
                            <optgroup label="Advanced Courses">
                                <option value="superintendent">SUPERINTENDENT</option>
                                <option value="pre-qualifying">PRE-QUALIFYING</option>
                            </optgroup>
                            <optgroup label="Regimental">
                                <option value="regimental-basic">REGIMENTAL BASIC</option>
                                <option value="regimental-b-iii-b-ii">REGIMENTAL B III ‚Äì B II</option>
                                <option value="regimental-b-ii-b-i">REGIMENTAL B II ‚Äì B I</option>
                            </optgroup>
                            <optgroup label="Specialized">
                                <option value="rso-rsi">RSO / RSI</option>
                                <option value="electronic-warfare-course">ELECTRONIC WARFARE COURSE</option>
                                <option value="tactical-drone-course">TACTICAL DRONE COURSE</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="filter-group" style="margin-top: 20px;">
                        <button onclick="releaseMidSemesterResults()" class="btn btn-warning" style="min-width: 200px; padding: 12px;">
                            üìä Release Mid-Semester Results
                        </button>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 3px solid #ffc107;">
                    <small style="color: #856404;">
                        <strong>‚ÑπÔ∏è Note:</strong> This will release results for BFT 1, Mid CS Exams, Mid Course Exercise, and all Quizzes/Tests done during mid-semester. 
                        Students will be able to view Quiz 1, Quiz 2, Quiz 3, and all other scores in their portal. 
                        The data will be saved and automatically included in final semester calculations.
                    </small>
                </div>
            </div>
        </div>

        <!-- End of Semester Results Release Section -->
        <div class="card" style="border-left: 4px solid #28a745; background: #f0fff4;">
            <h3 style="color: #155724; margin-bottom: 15px;">üéì End of Semester Results Release</h3>
            <p style="color: #666; margin-bottom: 20px;">
                After lecturers submit final exam scores, release complete final semester results. The system will automatically:
                <strong>Accumulate all scores from the database</strong> (mid-semester results + final exams + all quizzes) ‚Üí 
                <strong>Calculate and grade everything</strong> ‚Üí 
                <strong>Release to student portal</strong>. 
                Students will see Quiz 1, Quiz 2, Quiz 3, BFT 1, Mid Exams, Final Exams, and all other scores with their final grade.
            </p>
            <div class="filter-section" style="background: #fff; border: 1px solid #28a745; border-radius: 5px; padding: 15px;">
                <div class="filter-row">
                    <div class="filter-group" style="flex: 1;">
                        <label for="finalSemesterClass">Select Class</label>
                        <select id="finalSemesterClass" class="form-control">
                            <option value="all">All Classes</option>
                            <optgroup label="Signals">
                                <option value="signals-basic">SIGNALS BASIC</option>
                                <option value="signals-b-iii-b-ii">SIGNALS B III ‚Äì B II</option>
                                <option value="signals-b-ii-b-i">SIGNALS B II ‚Äì B I</option>
                            </optgroup>
                            <optgroup label="Advanced Courses">
                                <option value="superintendent">SUPERINTENDENT</option>
                                <option value="pre-qualifying">PRE-QUALIFYING</option>
                            </optgroup>
                            <optgroup label="Regimental">
                                <option value="regimental-basic">REGIMENTAL BASIC</option>
                                <option value="regimental-b-iii-b-ii">REGIMENTAL B III ‚Äì B II</option>
                                <option value="regimental-b-ii-b-i">REGIMENTAL B II ‚Äì B I</option>
                            </optgroup>
                            <optgroup label="Specialized">
                                <option value="rso-rsi">RSO / RSI</option>
                                <option value="electronic-warfare-course">ELECTRONIC WARFARE COURSE</option>
                                <option value="tactical-drone-course">TACTICAL DRONE COURSE</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="filter-group" style="margin-top: 20px;">
                        <button onclick="releaseFinalSemesterResults()" class="btn btn-success" style="min-width: 200px; padding: 12px;">
                            üéì Release Final Semester Results
                        </button>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #d4edda; border-radius: 5px; border-left: 3px solid #28a745;">
                    <small style="color: #155724;">
                        <strong>‚ÑπÔ∏è Note:</strong> This will release final semester results including all mid-semester results (already released), 
                        final semester exams (Opening, BFT 2, Final Exams, Final Exercise), and all quizzes accumulated throughout the semester.
                    </small>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <div>
                    <h3>All Students & Exam Results <small style="font-size: 14px; color: #666; font-weight: normal;">(Grouped by Class)</small></h3>
                    <small style="color: #666; font-size: 12px;">üîÑ Auto-refreshes every 30 seconds | üìä Tables scroll horizontally when content is wide</small>
                </div>
            </div>
            <div id="resultsContainer">
                <p class="empty-state">Loading results...</p>
            </div>
        </div>
        
        <!-- Manual Score Entry Section -->
        <div class="card">
            <h3>Manual Score Entry</h3>
            <p style="color: #666; margin-bottom: 20px;">
                Enter manual scores for BFT, Opening Exams, Mid Exercise, and Final Exercise. 
                All scores are entered per subject and will be added to automated scores.
            </p>
            <div class="filter-section">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="manualScoreClass">Class</label>
                        <select id="manualScoreClass" class="form-control">
                            <option value="">Select Class</option>
                            <optgroup label="Signals">
                                <option value="signals-basic">SIGNALS BASIC</option>
                                <option value="signals-b-iii-b-ii">SIGNALS B III ‚Äì B II</option>
                                <option value="signals-b-ii-b-i">SIGNALS B II ‚Äì B I</option>
                            </optgroup>
                            <optgroup label="Advanced Courses">
                                <option value="superintendent">SUPERINTENDENT</option>
                                <option value="pre-qualifying">PRE-QUALIFYING</option>
                            </optgroup>
                            <optgroup label="REGIMENTAL">
                                <option value="regimental-basic">REGIMENTAL BASIC</option>
                                <option value="regimental-b-iii-b-ii">REGIMENTAL B III ‚Äì B II</option>
                                <option value="regimental-b-ii-b-i">REGIMENTAL B II ‚Äì B I</option>
                            </optgroup>
                            <optgroup label="Specialized">
                                <option value="rso-rsi">RSO / RSI</option>
                                <option value="electronic-warfare-course">ELECTRONIC WARFARE COURSE</option>
                                <option value="tactical-drone-course">TACTICAL DRONE COURSE</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="manualScoreType">Score Type</label>
                        <select id="manualScoreType" class="form-control">
                            <option value="">Select Score Type</option>
                            <option value="bft_1">BFT 1 (2.5%)</option>
                            <option value="bft_2">BFT 2 (2.5%)</option>
                            <option value="opening_exam">Opening Exam (5%)</option>
                            <option value="mid_course_exercise">Mid Course Exercise (15%)</option>
                            <option value="final_cse_exercise">Final CSE Exercise (20%)</option>
                            <option value="quiz_manual">Quiz (Manual Entry - adds to automated)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="manualScoreSubject">Subject</label>
                        <select id="manualScoreSubject" class="form-control">
                            <option value="">Select Subject</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="manualScoreEntryContainer" style="margin-top: 20px;">
                <p class="empty-state">Select class, score type, and subject to enter manual scores</p>
            </div>
        </div>
        
        <!-- Final Grades Summary -->
        <div class="card">
            <h3>Final Grades Summary by Class</h3>
            <div id="finalGradesContainer">
                <p class="empty-state">Loading final grades...</p>
            </div>
        </div>
        
        <!-- User Management Section -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h3>User Management</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="loadAllUsers()" class="btn btn-primary">Refresh Users</button>
                    <button onclick="sortUsersByID()" class="btn btn-secondary">Sort by Student ID</button>
                    <button onclick="viewAllRegisteredSubjects()" class="btn btn-info">üìö View All Registered Subjects</button>
                    <button onclick="assignStudentIndices()" class="btn btn-warning">üî¢ Assign Student Indices</button>
                    <button onclick="exportUsersToCSV()" class="btn btn-success">Export Users</button>
                </div>
            </div>
            <div class="filter-section">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="userRoleFilter">Filter by Role</label>
                        <select id="userRoleFilter" class="form-control" onchange="loadAllUsers()">
                            <option value="all">All Roles</option>
                            <option value="student">Students</option>
                            <option value="lecturer">Lecturers</option>
                            <option value="admin">Admins</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="userClassFilter">Filter by Class</label>
                        <select id="userClassFilter" class="form-control" onchange="loadAllUsers()">
                            <option value="all">All Classes</option>
                            <optgroup label="Signals">
                                <option value="signals-basic">SIGNALS BASIC</option>
                                <option value="signals-b-iii-b-ii">SIGNALS B III ‚Äì B II</option>
                                <option value="signals-b-ii-b-i">SIGNALS B II ‚Äì B I</option>
                            </optgroup>
                            <optgroup label="Advanced Courses">
                                <option value="superintendent">SUPERINTENDENT</option>
                                <option value="pre-qualifying">PRE-QUALIFYING</option>
                            </optgroup>
                            <optgroup label="REGIMENTAL">
                                <option value="regimental-basic">REGIMENTAL BASIC</option>
                                <option value="regimental-b-iii-b-ii">REGIMENTAL B III ‚Äì B II</option>
                                <option value="regimental-b-ii-b-i">REGIMENTAL B II ‚Äì B I</option>
                            </optgroup>
                            <optgroup label="Specialized">
                                <option value="rso-rsi">RSO / RSI</option>
                                <option value="electronic-warfare-course">ELECTRONIC WARFARE COURSE</option>
                                <option value="tactical-drone-course">TACTICAL DRONE COURSE</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="userSearchFilter">Search Users</label>
                        <input type="text" id="userSearchFilter" class="form-control" placeholder="Search by name, username, or email..." oninput="loadAllUsers()" autocomplete="off">
                    </div>
                </div>
            </div>
            <div id="usersContainer" style="margin-top: 20px;">
                <p class="empty-state">Loading users...</p>
            </div>
        </div>
        
        <!-- Analytics & Reports Section -->
        <div class="card">
            <h3>Analytics & Reports</h3>
            <div class="admin-stats" style="margin-bottom: 30px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <h3>Pass Rate</h3>
                    <div class="value" id="passRate">0%</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    <h3>Fail Rate</h3>
                    <div class="value" id="failRate">0%</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <h3>Average Score</h3>
                    <div class="value" id="averageScore">0%</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
                    <h3>Total Classes</h3>
                    <div class="value" id="totalClasses">0</div>
                </div>
            </div>
            <div id="analyticsContainer">
                <p class="empty-state">Loading analytics...</p>
            </div>
        </div>
        
        <!-- Export Features Section -->
        <div class="card">
            <h3>Export Results</h3>
            <p style="color: #666; margin-bottom: 20px;">
                Export exam results and final grades to CSV/Excel format for external analysis.
            </p>
            <div class="filter-section">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="exportClass">Class</label>
                        <select id="exportClass" class="form-control">
                            <option value="all">All Classes</option>
                            <optgroup label="Signals">
                                <option value="signals-basic">SIGNALS BASIC</option>
                                <option value="signals-b-iii-b-ii">SIGNALS B III ‚Äì B II</option>
                                <option value="signals-b-ii-b-i">SIGNALS B II ‚Äì B I</option>
                            </optgroup>
                            <optgroup label="Advanced Courses">
                                <option value="superintendent">SUPERINTENDENT</option>
                                <option value="pre-qualifying">PRE-QUALIFYING</option>
                            </optgroup>
                            <optgroup label="REGIMENTAL">
                                <option value="regimental-basic">REGIMENTAL BASIC</option>
                                <option value="regimental-b-iii-b-ii">REGIMENTAL B III ‚Äì B II</option>
                                <option value="regimental-b-ii-b-i">REGIMENTAL B II ‚Äì B I</option>
                            </optgroup>
                            <optgroup label="Specialized">
                                <option value="rso-rsi">RSO / RSI</option>
                                <option value="electronic-warfare-course">ELECTRONIC WARFARE COURSE</option>
                                <option value="tactical-drone-course">TACTICAL DRONE COURSE</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="exportType">Export Type</label>
                        <select id="exportType" class="form-control">
                            <option value="all_results">All Exam Results</option>
                            <option value="final_grades">Final Grades Only</option>
                            <option value="by_subject">Results by Subject</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button onclick="exportResults()" class="btn btn-success" style="min-width: 150px;">Export to CSV</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- System Settings Section -->
        <div class="card">
            <h3>System Settings</h3>
            <p style="color: #666; margin-bottom: 20px;">
                Configure grade thresholds and exam type percentages. Changes affect how final grades are calculated.
            </p>
            <div class="filter-section">
                <h4 style="margin-bottom: 15px; color: var(--primary-color);">Grade Thresholds</h4>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="gradeA">Grade A (Minimum %)</label>
                        <input type="number" id="gradeA" class="form-control" value="80" min="0" max="100">
                    </div>
                    <div class="filter-group">
                        <label for="gradeB">Grade B (Minimum %)</label>
                        <input type="number" id="gradeB" class="form-control" value="70" min="0" max="100">
                    </div>
                    <div class="filter-group">
                        <label for="gradeC">Grade C (Minimum %)</label>
                        <input type="number" id="gradeC" class="form-control" value="60" min="0" max="100">
                    </div>
                    <div class="filter-group">
                        <label for="gradeD">Grade D (Minimum %)</label>
                        <input type="number" id="gradeD" class="form-control" value="50" min="0" max="100">
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button onclick="saveGradeThresholds()" class="btn btn-primary">Save Grade Thresholds</button>
                    <button onclick="resetGradeThresholds()" class="btn btn-secondary">Reset to Default</button>
                </div>
            </div>
        </div>
        
        <!-- Database Management Section -->
        <div class="card" style="border: 2px solid #dc3545;">
            <h3 style="color: #dc3545;">üóÑÔ∏è Database Management</h3>
            <p style="color: #666; margin-bottom: 20px;">
                <strong>‚ö†Ô∏è WARNING:</strong> Database operations are irreversible. Always backup data before clearing.
            </p>
            
            <!-- Database Statistics -->
            <div class="filter-section" style="background: #f8f9fa;">
                <h4 style="margin-bottom: 15px; color: var(--primary-color);">Database Statistics</h4>
                <div class="admin-stats" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                    <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                        <h3>Total Users</h3>
                        <div class="value" id="dbTotalUsers">-</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <h3>Students</h3>
                        <div class="value" id="dbStudents">-</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
                        <h3>Lecturers</h3>
                        <div class="value" id="dbLecturers">-</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                        <h3>Exams</h3>
                        <div class="value" id="dbExams">-</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);">
                        <h3>Materials</h3>
                        <div class="value" id="dbMaterials">-</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #fd7e14 0%, #e8650e 100%);">
                        <h3>Grades</h3>
                        <div class="value" id="dbGrades">-</div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="loadDatabaseStats()" class="btn btn-primary">Refresh Statistics Now</button>
                    <small style="display: block; margin-top: 8px; color: #666; font-size: 12px;">‚ÑπÔ∏è Statistics auto-refresh every 30 seconds</small>
                </div>
            </div>
            
            <!-- Backup Options -->
            <div class="filter-section" style="background: #d4edda; border-left: 4px solid #28a745;">
                <h4 style="margin-bottom: 15px; color: #155724;">üì¶ Backup Data</h4>
                <p style="color: #155724; margin-bottom: 15px;">
                    Export all data before clearing. Backups are saved as JSON files.
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="backupAllData()" class="btn btn-success">Backup All Data</button>
                    <button onclick="backupUsers()" class="btn btn-success">Backup Users Only</button>
                    <button onclick="backupExams()" class="btn btn-success">Backup Exams & Results</button>
                    <button onclick="backupMaterials()" class="btn btn-success">Backup Materials</button>
                </div>
            </div>
            
            <!-- Clear Options -->
            <div class="filter-section" style="background: #f8d7da; border-left: 4px solid #dc3545;">
                <h4 style="margin-bottom: 15px; color: #721c24;">üóëÔ∏è Clear Data</h4>
                <p style="color: #721c24; margin-bottom: 15px;">
                    <strong>‚ö†Ô∏è DANGER ZONE:</strong> These operations cannot be undone. Always backup first!
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="deleteDataByClass()" class="btn btn-warning">Delete Data by Class</button>
                    <button onclick="clearTestData()" class="btn btn-warning">Clear Test/Demo Data Only</button>
                    <button onclick="clearAllData()" class="btn btn-danger">Clear ALL Data</button>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
                    <strong style="color: #856404;">üìã Delete by Class:</strong>
                    <p style="color: #856404; font-size: 13px; margin: 5px 0 0 0;">
                        Deletes all data for a specific class (students, exams, results). Useful for cleaning up specific classes.
                    </p>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 5px;">
                    <h5 style="color: #721c24; margin-bottom: 10px;">Alternative: Use SQL Scripts</h5>
                    <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                        For more control, you can use SQL scripts in Supabase Dashboard:
                    </p>
                    <ul style="color: #666; font-size: 14px; margin-left: 20px;">
                        <li><code>exam-portal/supabase-clear-all-data-complete.sql</code> - Clear all data</li>
                        <li><code>exam-portal/supabase-clear-test-data.sql</code> - Clear test data only</li>
                        <li><code>lms/supabase-clear-all-data.sql</code> - Clear LMS data</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/security.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/supabase-helpers.js"></script>
    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/performance-optimizer.js"></script>
    <script src="js/admin-portal.js?v=20260127"></script>
    <script src="js/modal.js"></script>
    
    <!-- Modal for Messages -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <div class="modal-icon" id="modalIcon"></div>
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <button id="modalButton" class="btn btn-primary">OK</button>
        </div>
    </div>
    
    <!-- Modal for All Registered Subjects -->
    <div id="registeredSubjectsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <span class="modal-close" onclick="closeRegisteredSubjectsModal()">&times;</span>
            <h2 style="color: var(--primary-color); margin-bottom: 20px;">üìö All Registered Subjects by Students</h2>
            <div class="filter-section" style="margin-bottom: 20px;">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="subjectViewFilter">Filter by Subject</label>
                        <select id="subjectViewFilter" class="form-control" onchange="filterSubjectView()">
                            <option value="all">All Subjects</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="subjectViewClassFilter">Filter by Class</label>
                        <select id="subjectViewClassFilter" class="form-control" onchange="filterSubjectView()">
                            <option value="all">All Classes</option>
                            <optgroup label="Signals">
                                <option value="signals-basic">SIGNALS BASIC</option>
                                <option value="signals-b-iii-b-ii">SIGNALS B III ‚Äì B II</option>
                                <option value="signals-b-ii-b-i">SIGNALS B II ‚Äì B I</option>
                            </optgroup>
                            <optgroup label="Advanced Courses">
                                <option value="superintendent">SUPERINTENDENT</option>
                                <option value="pre-qualifying">PRE-QUALIFYING</option>
                            </optgroup>
                            <optgroup label="REGIMENTAL">
                                <option value="regimental-basic">REGIMENTAL BASIC</option>
                                <option value="regimental-b-iii-b-ii">REGIMENTAL B III ‚Äì B II</option>
                                <option value="regimental-b-ii-b-i">REGIMENTAL B II ‚Äì B I</option>
                            </optgroup>
                            <optgroup label="Specialized">
                                <option value="rso-rsi">RSO / RSI</option>
                                <option value="electronic-warfare-course">ELECTRONIC WARFARE COURSE</option>
                                <option value="tactical-drone-course">TACTICAL DRONE COURSE</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
            </div>
            <div id="registeredSubjectsContent">
                <p class="empty-state">Loading registered subjects...</p>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="closeRegisteredSubjectsModal()" class="btn btn-secondary">Close</button>
                <button onclick="exportRegisteredSubjectsToCSV()" class="btn btn-success" style="margin-left: 10px;">Export to CSV</button>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2026 Signal Training School. All rights reserved.</p>
        <p style="font-size: 16px; font-weight: 600; margin: 10px 0; opacity: 1 !important;">
            Developed and Powered by <strong style="color: #ffffff; font-size: 1.2em; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">Frank Kojo Dogbe</strong> | Co-developed by Solomon A. Nortey
        </p>
    </footer>
</body>
</html>
