<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Portal - Login</title>
    <link rel="icon" type="image/png" href="../images/led.jpg">
    <link rel="shortcut icon" type="image/png" href="../images/led.jpg">
    <link rel="apple-touch-icon" href="../images/led.jpg">
    <script>
        // Prevent any redirects from app.js by setting a flag early
        window.IS_EXAM_PORTAL = true;
    </script>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .login-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
        }
        
        .login-box {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 420px;
            position: relative;
            z-index: 1;
        }
        
        .logo-section {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .logo-img {
            max-width: 100%;
            width: auto;
            height: auto;
            max-height: 120px;
            margin-bottom: 15px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 8px;
            background: rgba(255, 255, 255, 0.95);
        }
        
        .welcome-title {
            color: var(--primary-color);
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            letter-spacing: 0.5px;
            line-height: 1.3;
        }
        
        .exam-portal-badge {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <div class="logo-section">
                <h1 class="welcome-title">Ghana Armed Forces Signals Training School</h1>
                <span class="exam-portal-badge">Exam Portal</span>
                <img src="../images/led.jpg" alt="Signal Training School Logo" class="logo-img" onerror="this.style.display='none';">
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" placeholder="Enter your username" required>
                </div>
                
                <div class="form-group" style="position: relative;">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" placeholder="Enter your password" required style="padding-right: 45px;">
                    <span class="password-toggle" onclick="togglePassword('password')" style="position: absolute; right: 15px; top: 38px; cursor: pointer; font-size: 18px; color: #666; user-select: none;">üëÅÔ∏è</span>
                </div>
                
                <div class="form-group">
                    <label for="userType">Login As</label>
                    <select id="userType" name="userType" required>
                        <option value="">Select Role</option>
                        <option value="lecturer">Lecturer</option>
                        <option value="student">Student</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary">Login to Exam Portal</button>
                
                <div style="text-align: center; margin-top: 15px;">
                    <a href="../index.html" style="color: var(--primary-color); font-size: 14px; text-decoration: none;">‚Üê Back to LMS Portal</a>
                </div>
                
                <div id="errorMessage" class="error-message"></div>
            </form>
        </div>
    </div>
    
    <!-- Security Utilities (must load first) -->
    <script src="../js/security.js" onerror="console.error('Failed to load security.js')"></script>
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js" onerror="console.error('Failed to load supabase-config.js')"></script>
    <script src="../js/supabase-helpers.js" onerror="console.error('Failed to load supabase-helpers.js')"></script>
    <script src="../js/modal.js" onerror="console.error('Failed to load modal.js')"></script>
    <script>
        // Exam Portal Login Handler - separate from main LMS login
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                // Ensure CSRF token is added to form before attaching handler
                if (typeof SecurityUtils !== 'undefined' && SecurityUtils.addCSRFTokenToForm) {
                    SecurityUtils.addCSRFTokenToForm(loginForm);
                }
                
                loginForm.addEventListener('submit', handleExamPortalLogin);
            }
            
            // Check if already logged in
            const currentUser = getCurrentUser();
            if (currentUser) {
                // Redirect to appropriate exam portal
                if (currentUser.role === 'lecturer') {
                    window.location.href = 'lecturer-exam-dashboard.html';
                } else if (currentUser.role === 'student') {
                    window.location.href = 'student-exam-portal.html';
                }
            }
        });
        
        // Get current user from sessionStorage
        function getCurrentUser() {
            const userStr = sessionStorage.getItem('currentUser');
            return userStr ? JSON.parse(userStr) : null;
        }
        
        // Set current user
        function setCurrentUser(user) {
            sessionStorage.setItem('currentUser', JSON.stringify(user));
        }
        
        // Handle exam portal login
        async function handleExamPortalLogin(e) {
            e.preventDefault();
            
            const form = e.target;
            
            // Ensure CSRF token exists before validation
            if (typeof SecurityUtils !== 'undefined' && SecurityUtils.addCSRFTokenToForm) {
                SecurityUtils.addCSRFTokenToForm(form);
            }
            
            // Validate CSRF token (with fallback for migration period)
            if (typeof SecurityUtils !== 'undefined' && SecurityUtils.validateFormCSRFToken) {
                const isValid = SecurityUtils.validateFormCSRFToken(form);
                if (!isValid) {
                    // During migration, try once more by regenerating token
                    if (typeof SecurityUtils !== 'undefined' && SecurityUtils.getCSRFToken) {
                        // Clear old token and get new one
                        try {
                            sessionStorage.removeItem('csrfToken');
                            SecurityUtils.getCSRFToken();
                            SecurityUtils.addCSRFTokenToForm(form);
                            
                            // Try validation again
                            if (!SecurityUtils.validateFormCSRFToken(form)) {
                                const errorMessage = document.getElementById('errorMessage');
                                if (errorMessage) {
                                    errorMessage.textContent = 'Security token validation failed. Please refresh the page and try again.';
                                    errorMessage.classList.add('show');
                                }
                                return;
                            }
                        } catch (err) {
                            console.error('CSRF token error:', err);
                            // Allow submission during migration period if SecurityUtils fails
                            console.warn('Allowing form submission due to CSRF token error during migration');
                        }
                    } else {
                        const errorMessage = document.getElementById('errorMessage');
                        if (errorMessage) {
                            errorMessage.textContent = 'Security token validation failed. Please refresh the page and try again.';
                            errorMessage.classList.add('show');
                        }
                        return;
                    }
                }
            }
            
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const userTypeInput = document.getElementById('userType');
            const errorMessage = document.getElementById('errorMessage');
            
            // Sanitize inputs
            const username = usernameInput ? (typeof SecurityUtils !== 'undefined' && SecurityUtils.sanitizeInput ? SecurityUtils.sanitizeInput(usernameInput.value) : usernameInput.value.trim()) : '';
            const password = passwordInput ? passwordInput.value : '';
            const userType = userTypeInput ? userTypeInput.value : '';
            
            // Clear previous errors
            errorMessage.classList.remove('show');
            errorMessage.textContent = '';
            
            // Validate inputs
            if (!username || !password || !userType) {
                errorMessage.textContent = 'Please fill in all fields';
                errorMessage.classList.add('show');
                return;
            }
            
            // Rate limiting check
            if (typeof SecurityUtils !== 'undefined' && SecurityUtils.checkRateLimit) {
                const rateLimitKey = `login_${username}`;
                const rateLimit = SecurityUtils.checkRateLimit(rateLimitKey, 5, 15);
                if (!rateLimit.allowed) {
                    errorMessage.textContent = `Too many login attempts. Please try again in ${rateLimit.timeRemaining} minutes.`;
                    errorMessage.classList.add('show');
                    return;
                }
            }
            
            // Try Supabase first, fallback to localStorage
            let user = null;
            
            if (typeof getUserFromSupabase === 'function') {
                try {
                    user = await getUserFromSupabase(username, password, userType);
                } catch (err) {
                    console.error('Supabase login error:', err);
                    errorMessage.textContent = 'Login failed. Please try again.';
                    errorMessage.classList.add('show');
                    return;
                }
            }
            
            // Fallback to localStorage (with password verification if SecurityUtils available)
            if (!user && typeof localStorage !== 'undefined') {
                try {
                    const users = JSON.parse(localStorage.getItem('users') || '[]');
                    const potentialUser = users.find(u => u.username === username && u.role === userType);
                    if (potentialUser && typeof SecurityUtils !== 'undefined' && SecurityUtils.verifyPassword) {
                        const passwordMatch = await SecurityUtils.verifyPassword(password, potentialUser.password);
                        if (passwordMatch) {
                            user = potentialUser;
                            delete user.password;
                        }
                    } else if (potentialUser && potentialUser.password === password) {
                        // Legacy plaintext support
                        user = potentialUser;
                        delete user.password;
                    }
                } catch (err) {
                    console.error('LocalStorage login error:', err);
                }
            }
            
            if (user) {
                // Clear rate limit on successful login
                if (typeof SecurityUtils !== 'undefined' && SecurityUtils.clearRateLimit) {
                    SecurityUtils.clearRateLimit(`login_${username}`);
                }
                
                // Set secure session
                if (typeof SecurityUtils !== 'undefined' && SecurityUtils.setSecureSession) {
                    SecurityUtils.setSecureSession(user, 480); // 8 hour session
                }
                
                // Set current user (legacy support)
                setCurrentUser(user);
                
                // Redirect to exam portal based on role
                if (userType === 'lecturer') {
                    window.location.href = 'lecturer-exam-dashboard.html';
                } else if (userType === 'student') {
                    window.location.href = 'student-exam-portal.html';
                }
            } else {
                errorMessage.textContent = 'Invalid username, password, or role';
                errorMessage.classList.add('show');
            }
        }
    </script>
    
    <script>
        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const toggle = event.target;
            
            if (input.type === 'password') {
                input.type = 'text';
                toggle.textContent = 'üôà';
            } else {
                input.type = 'password';
                toggle.textContent = 'üëÅÔ∏è';
            }
        }
    </script>
    
    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2026 Ghana Armed Forces Signals Training School. All rights reserved.</p>
        <p style="font-size: 16px; font-weight: 600; margin: 10px 0; opacity: 1 !important;">Developed and Powered by <strong style="color: #ffffff; font-size: 1.2em; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">Frank Kojo Dogbe</strong> | Co-developed by Solomon A. Nortey</p>
        <p style="margin-top: 10px;"><a href="#help" onclick="showHelpModal(); return false;" style="color: white; text-decoration: underline; cursor: pointer;">üìû Need Help?</a></p>
    </footer>
    
    <!-- Help Modal -->
    <div id="helpModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeHelpModal()">&times;</span>
            <h2>üìû Need Help?</h2>
            <div style="text-align: left; margin-top: 20px;">
                <h3>Common Issues:</h3>
                <ul style="line-height: 1.8;">
                    <li><strong>Login Problems:</strong> Check your username/password, ensure you've selected the correct role (Lecturer/Student)</li>
                    <li><strong>Exam Access:</strong> Verify you're registered for the exam and it's active</li>
                    <li><strong>Browser Issues:</strong> Try clearing cache or using a different browser</li>
                    <li><strong>Console Errors:</strong> Press F12 to open developer tools and check the Console tab</li>
                </ul>
                <h3 style="margin-top: 20px;">Technical Support:</h3>
                <p>If you experience any issues, please seek support from Signal Training School.</p>
            </div>
            <button onclick="closeHelpModal()" class="btn btn-primary" style="margin-top: 20px;">Close</button>
        </div>
    </div>
    
    <script>
    function showHelpModal() {
        document.getElementById('helpModal').style.display = 'flex';
    }
    function closeHelpModal() {
        document.getElementById('helpModal').style.display = 'none';
    }
    window.onclick = function(event) {
        const modal = document.getElementById('helpModal');
        if (event.target == modal) {
            closeHelpModal();
        }
    }
    </script>
</body>
</html>

